<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>noai背单词</title>
    <style>
        body {
            background-color: #f0f0f0;
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .container {
            text-align: center;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 300px;
            min-height: 80vh; /* Ensure the container takes at least 90% of the viewport height */
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .refresh-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
            color: #555;
        }
        .settings-icon {
            position: absolute;
            top: 10px;
            left: 10px;
            cursor: pointer;
            font-size: 20px;
            color: #555;
        }
        textarea {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            resize: vertical;
            flex-grow: 1; /* Allow textarea to grow and fill available space */
        }
        input[type="text"] {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button#submitBtn {
            background-color: #007bff;
            color: white;
        }
        button#restartBtn {
            background-color: #dc3545;
            color: white;
        }
        button#luckyBtn {
            background-color: #28a745;
            color: white;
        }
        button#savePrizesBtn {
            background-color: #28a745;
            color: white;
        }
        .result {
            margin-top: 10px;
            font-size: 18px;
        }
        .correct {
            color: green;
        }
        .incorrect {
            color: red;
        }
        #quizContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-grow: 1;
        }
        #startButtonContainer {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }
        select {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        #unitSelectionContainer {
            margin-bottom: 10px;
        }
        #modeSelectionContainer {
            margin-bottom: 10px;
        }
        #questionNumber {
            margin-bottom: 10px;
            font-size: 16px;
        }
        #question {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        #currentUnit {
            margin-bottom: 10px;
            font-size: 16px;
            font-weight: bold;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            border-radius: 10px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .prize-input {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <span class="refresh-icon" onclick="location.reload()">&#8635;</span>
        <span class="settings-icon" onclick="openModal()">&#9881;</span>
        <h2>noai背单词</h2>
        <div id="unitSelectionContainer">
            <select id="unitSelect" onchange="updateWords()">
                <option value="">请选择单词组</option>
            </select>
        </div>
        <textarea id="wordInput" rows="5" placeholder="单词或词组（每行一个，格式为 英文:中文）" readonly></textarea><br>
        <div id="modeSelectionContainer">
            <label for="modeSelect">选择模式:</label>
            <select id="modeSelect">
                <option value="chiToEng">中翻英</option>
                <!--<option value="engToChi">英翻中</option>-->
                <option value="mixed">中英混合</option>
            </select>
        </div>
        <div id="startButtonContainer">
            <button onclick="startQuiz()">开始测试</button>
        </div>
        <div id="quizContainer" style="display:none;">
            <p id="currentUnit"></p>
            <p id="questionNumber"></p>
            <p id="question"></p>
            <input type="text" id="answerInput"><br>
            <button id="submitBtn" onclick="checkAnswer()">提交</button>
            <div id="result" class="result"></div>
            <button id="restartBtn" onclick="restartQuiz()" style="display:none;">重新开始</button>
            <button id="luckyBtn" onclick="window.location.href='https://icloudbi.github.io/words/lucky.html'" style="display:none;">抽奖游戏</button>
        </div>
    </div>

    <!-- Modal -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>设置奖品名称</h2>
            <div id="prizeInputs">
                <!-- Prize inputs will be dynamically added here -->
            </div>
            <button id="savePrizesBtn" onclick="savePrizes()">保存</button>
        </div>
    </div>

    <script>
        let selectedUnitName = '';
        let prizes = [];
        let highestAccuracies = {};

        async function loadUnits() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/icloudbi/words/main/list.txt');
                if (!response.ok) throw new Error('无法加载 list.txt 文件');
                const data = await response.text();
                const lines = data.trim().split('\n');

                const unitSelect = document.getElementById('unitSelect');
                lines.forEach(line => {
                    const [name, url] = line.split(',').map(part => part.trim());
                    if (name && url) {
                        const option = document.createElement('option');
                        option.value = url;
                        option.textContent = getUnitDisplayText(name);
                        unitSelect.appendChild(option);
                    }
                });
                // Load highest accuracies from localStorage
                const storedAccuracies = localStorage.getItem('highestAccuracies');
                if (storedAccuracies) {
                    highestAccuracies = JSON.parse(storedAccuracies);
                }
            } catch (error) {
                console.error(error);
                alert('无法加载单元列表，请检查 list.txt 文件是否存在并正确配置。');
            }
        }

        function updateWords() {
            const selectedUrl = document.getElementById('unitSelect').value;
            const wordInput = document.getElementById('wordInput');

            if (selectedUrl === '') {
                wordInput.value = '';
                wordInput.readOnly = true;
                selectedUnitName = '';
            } else {
                wordInput.value = '正在加载中...';
                wordInput.readOnly = true;
                
                fetch(selectedUrl)
                    .then(response => {
                        if (!response.ok) throw new Error(`无法加载 ${selectedUrl}`);
                        return response.text();
                    })
                    .then(data => {
                        wordInput.value = addLineNumbers(data.trim());
                        selectedUnitName = document.getElementById('unitSelect').options[document.getElementById('unitSelect').selectedIndex].textContent.split(' ')[0];
                    })
                    .catch(error => {
                        console.error(error);
                        alert('无法加载单词数据文件，请检查 URL 是否正确。');
                        wordInput.value = '';
                    });
            }
        }
        
        function addLineNumbers(text) {
            const lines = text.split('\n');
            const numberedLines = lines.map((line, index) => `${index + 1}. ${line}`);
            return numberedLines.join('\n');
        }

        let words = [];
        let shuffledWords = [];
        let currentWordIndex = 0;
        let correctAnswers = 0;
        let consecutiveCorrect = 0;
        let consecutiveIncorrect = 0;

        function startQuiz() {
            const inputText = document.getElementById('wordInput').value.trim();
            if (!inputText) return alert('请输入单词或词组');

            words = inputText.split('\n').map(line => line.trim()).filter(line => line.length > 0);

            // Remove line numbers before processing
            words = words.map(line => line.replace(/^\d+\.\s*/, ''));

            // Filter out invalid lines and split into pairs
            words = words.filter(line => line.includes(':')).map(line => line.split(':').map(part => part.trim()));

            if (words.length === 0) return alert('请输入有效的单词或词组（格式为 英文:中文）');

            shuffleArray(words);
            shuffledWords = [...words];
            currentWordIndex = 0;
            correctAnswers = 0;
            consecutiveCorrect = 0;
            consecutiveIncorrect = 0;

            document.getElementById('wordInput').style.display = 'none';
            document.getElementById('startButtonContainer').style.display = 'none';
            document.getElementById('unitSelectionContainer').style.display = 'none'; // Hide unit selection container
            document.getElementById('modeSelectionContainer').style.display = 'none'; // Hide mode selection container
            document.getElementById('quizContainer').style.display = 'flex';

            document.getElementById('currentUnit').innerText = `测试内容: ${selectedUnitName}`;

            showNextQuestion();
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function showNextQuestion() {
            if (currentWordIndex >= shuffledWords.length) {
                endQuiz();
                return;
            }

            const [english, chinese] = shuffledWords[currentWordIndex];
            const mode = document.getElementById('modeSelect').value;
            let question = '';

            if (mode === 'engToChi') {
                question = english;
            } else if (mode === 'chiToEng') {
                question = chinese;
            } else if (mode === 'mixed') {
                question = Math.random() < 0.5 ? english : chinese;
            }

            document.getElementById('question').innerText = question;
            document.getElementById('answerInput').value = '';
            document.getElementById('result').innerText = '';

            // Update question number
            document.getElementById('questionNumber').innerText = `第 ${currentWordIndex + 1} / 共 ${shuffledWords.length} 个`;
        }

        function checkAnswer() {
            const answer = document.getElementById('answerInput').value.trim();
            const [english, chinese] = shuffledWords[currentWordIndex];
            const mode = document.getElementById('modeSelect').value;

            let isCorrect = false;
            if (mode === 'engToChi' || mode === 'mixed' && document.getElementById('question').innerText.includes(english)) {
                isCorrect = answer.toLowerCase() === chinese.toLowerCase();
            } else if (mode === 'chiToEng' || mode === 'mixed' && document.getElementById('question').innerText.includes(chinese)) {
                isCorrect = answer.toLowerCase() === english.toLowerCase();
            }

            if (isCorrect) {
                correctAnswers++;
                consecutiveCorrect++;
                consecutiveIncorrect = 0;

                if (consecutiveCorrect === 5) {
                    document.getElementById('result').innerText = '太棒了！继续加油！ ✔️';
                } else if (consecutiveCorrect === 10) {
                    document.getElementById('result').innerText = '你真是天才！ 🌟';
                } else {
                    document.getElementById('result').innerText = '正确 ✔️';
                }

                document.getElementById('result').classList.add('correct');
            } else {
                consecutiveIncorrect++;
                consecutiveCorrect = 0;

                if (consecutiveIncorrect >= 2) {
                    document.getElementById('result').innerText = `别灰心，继续努力！ ❌ 正确答案是: ${english} -> ${chinese}`;
                } else {
                    document.getElementById('result').innerText = `错误 ❌ 正确答案是: ${english} -> ${chinese}`;
                }

                document.getElementById('result').classList.add('incorrect');
            }

            setTimeout(() => {
                document.getElementById('result').innerText = '';
                document.getElementById('result').classList.remove('correct', 'incorrect');
                currentWordIndex++;
                showNextQuestion();
            }, 1500);
        }

        function endQuiz() {
            const accuracy = ((correctAnswers / shuffledWords.length) * 100).toFixed(2);
            let message = '';

            if (accuracy < 60) {
                message = `测试结束！正确率: ${accuracy}%。别灰心，继续努力！`;
            } else if (accuracy >= 60 && accuracy < 80) {
                message = `测试结束！正确率: ${accuracy}%。加油，你可以更棒！`;
            } else if (accuracy >= 80 && accuracy < 90) {
                message = `测试结束！正确率: ${accuracy}%。真不错，继续保持！`;
            } else {
                message = `测试结束！正确率: ${accuracy}%。非常好！`;
            }

            document.getElementById('question').innerText = message;
            document.getElementById('answerInput').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('restartBtn').style.display = 'block';

            if (accuracy > 90) {
                document.getElementById('luckyBtn').style.display = 'block';
            } else {
                document.getElementById('luckyBtn').style.display = 'none';
            }

            document.getElementById('questionNumber').innerText = ''; // Clear question number

            // Update highest accuracy for the current unit
            if (!highestAccuracies[selectedUnitName] || parseFloat(highestAccuracies[selectedUnitName]) < parseFloat(accuracy)) {
                highestAccuracies[selectedUnitName] = accuracy;
                localStorage.setItem('highestAccuracies', JSON.stringify(highestAccuracies));

                // Update the unit display in the dropdown
                const unitOptions = document.getElementById('unitSelect').options;
                for (let i = 0; i < unitOptions.length; i++) {
                    if (unitOptions[i].textContent.startsWith(selectedUnitName)) {
                        unitOptions[i].textContent = getUnitDisplayText(unitOptions[i].textContent.split(' ')[0]);
                        break;
                    }
                }
            }
        }

        function restartQuiz() {
            document.getElementById('unitSelect').value = '';
            document.getElementById('wordInput').value = '';
            document.getElementById('wordInput').readOnly = true;
            document.getElementById('modeSelect').value = 'chiToEng'; // Default mode set to 中翻英
            document.getElementById('wordInput').style.display = 'block';
            document.getElementById('startButtonContainer').style.display = 'block';
            document.getElementById('unitSelectionContainer').style.display = 'block'; // Show unit selection container
            document.getElementById('modeSelectionContainer').style.display = 'block'; // Show mode selection container
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('question').innerText = '';
            document.getElementById('answerInput').value = ''; // Ensure answerInput is cleared
            document.getElementById('answerInput').style.display = 'block'; // Show answerInput
            document.getElementById('submitBtn').style.display = 'block'; // Show submitBtn
            document.getElementById('result').innerText = '';
            document.getElementById('restartBtn').style.display = 'none';
            document.getElementById('luckyBtn').style.display = 'none';
            document.getElementById('questionNumber').innerText = ''; // Clear question number
            document.getElementById('currentUnit').innerText = ''; // Clear current unit
        }

        function openModal() {
            loadPrizes();
            document.getElementById('myModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('myModal').style.display = 'none';
        }

        function createPrizeInputs() {
            const prizeInputsDiv = document.getElementById('prizeInputs');
            prizeInputsDiv.innerHTML = ''; // Clear existing inputs

            for (let i = 0; i < 8; i++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'prize-input';
                input.placeholder = `奖品${i + 1}`;
                input.value = prizes[i] || '';
                prizeInputsDiv.appendChild(input);
            }
        }

        function savePrizes() {
            const inputs = document.querySelectorAll('.prize-input');
            prizes = Array.from(inputs).map(input => input.value.trim());
            localStorage.setItem('prizes', JSON.stringify(prizes));
            closeModal();
        }

        function loadPrizes() {
            const storedPrizes = localStorage.getItem('prizes');
            if (storedPrizes) {
                prizes = JSON.parse(storedPrizes);
            } else {
                prizes = ["未中奖", "看一部电影", "未中奖", "一个冰淇淋", "5元小礼品", "一份小零食", "未中奖", "一张免学券"];
            }
            createPrizeInputs();
        }

        function getUnitDisplayText(unitName) {
            const highestAccuracy = highestAccuracies[unitName] || '0.0';
            return `${unitName} (${highestAccuracy}%)`;
        }
        
        window.onload = () => {
            loadUnits(); // Load units from list.txt
            loadPrizes();
        };
    </script>
</body>
</html>
